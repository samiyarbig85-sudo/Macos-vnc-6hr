name: macOS GUI via VNC (Tailscale)

on:
  workflow_dispatch:

jobs:
  macos_vnc:
    runs-on: macos-latest
    timeout-minutes: 360 # Ú©Ù„ Ø²Ù…Ø§Ù† Ø§Ø¬Ø±Ø§ÛŒ ÙˆØ±Ú©Ù„â€ŒÙÙ„Ùˆ (6 Ø³Ø§Ø¹Øª)

    steps:
    - name: Show system info
      run: |
        sw_vers
        uname -a

    - name: Setup Tailscale
      uses: tailscale/github-action@v3
      with:
        # Ø­ØªÙ…Ø§ Ø§ÛŒÙ† Ø³Ú©Ø±Øª Ø±Ø§ Ø¯Ø± ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ú¯ÛŒØªâ€ŒÙ‡Ø§Ø¨ ØªØ¹Ø±ÛŒÙ Ú©Ù†ÛŒØ¯
        authkey: ${{ secrets.TAILSCALE_AUTHKEY }}

    - name: Enable macOS Native VNC (Screen Sharing)
      run: |
        # ØªØ¹ÛŒÛŒÙ† Ù¾Ø³ÙˆØ±Ø¯ Ø¨Ø±Ø§ÛŒ ÛŒÙˆØ²Ø± runner (Ø¨Ø±Ø§ÛŒ Ù„Ø§Ú¯ÛŒÙ† Ø§ÙˆÙ„ÛŒÙ‡)
        sudo dscl . -passwd /Users/runner password
        
        # ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø³Ø±ÙˆÛŒØ³ Remote Management Ùˆ ØªØ¹ÛŒÛŒÙ† Ù¾Ø³ÙˆØ±Ø¯ VNC
        sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -activate -configure -allowAccessFor -allUsers -privs -all \
          -clientopts -setvncpassword -vncpasswd password \
          -restart -agent -quiet
        
        echo "âœ… Native VNC is enabled!"

    - name: Print Connection Info
      run: |
        # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¢ÛŒâ€ŒÙ¾ÛŒ Ø§Ø®ØªØµØ§ØµÛŒ Ø§ÛŒÙ† Ù…Ø§Ø´ÛŒÙ† Ø¯Ø± Ø´Ø¨Ú©Ù‡ Tailscale Ø´Ù…Ø§
        IP=$(tailscale ip -4)
        echo "------------------------------------------"
        echo "ğŸš€ CONNECT TO YOUR MAC:"
        echo "Address: $IP:5900"
        echo "Username: runner"
        echo "Password: password"
        echo "------------------------------------------"

    - name: Keep session alive for 6 hours
      run: |
        echo "â³ Session is live. Use the IP above to connect."
        echo "The session will automatically close after 6 hours."
        # Ù†Ú¯Ù‡ Ø¯Ø§Ø´ØªÙ† Ø³Ø´Ù† Ø¨Ù‡ Ù…Ø¯Øª 6 Ø³Ø§Ø¹Øª
        sleep 21600
        
