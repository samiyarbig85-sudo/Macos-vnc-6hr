name: macOS GUI via VNC (6 Hour Session) - Tailscale

on:
  workflow_dispatch:

jobs:
  macos_vnc:
    runs-on: macos-latest
    timeout-minutes: 360  # 6 hours

    steps:
    - name: Show system info
      run: |
        sw_vers
        uname -a
        whoami

    - name: Install VNC
      run: |
        brew install --quiet tiger-vnc
        mkdir -p ~/.vnc
        echo "password" | vncpasswd -f > ~/.vnc/passwd
        chmod 600 ~/.vnc/passwd

    - name: Setup Tailscale
      uses: tailscale/github-action@v3
      with:
        authkey: ${{ secrets.TAILSCALE_AUTHKEY }}
        # optional: tags: tag:ci

    - name: Start VNC Server
      run: |
        echo "#!/bin/bash" > ~/.vnc/xstartup
        echo "unset SESSION_MANAGER" >> ~/.vnc/xstartup
        echo "unset DBUS_SESSION_BUS_ADDRESS" >> ~/.vnc/xstartup
        echo "exec /System/Applications/Utilities/Terminal.app/Contents/MacOS/Terminal &" >> ~/.vnc/xstartup
        chmod +x ~/.vnc/xstartup
        vncserver :1 -geometry 1280x800 -depth 24

    - name: Print Connection Info
      run: |
        IP=$(tailscale ip -4)
        echo "üîó VNC connection info:"
        echo "Connect to: $IP:5901"
        echo "Password: password"

    - name: Keep session alive for 6 hours
      run: |
        echo "‚è≥ Session started. VNC is live for 6 hours."
        sleep 21600  # 6 hours
        
