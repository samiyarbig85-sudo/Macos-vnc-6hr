name: macOS GUI via VNC (Safe OAuth Version)

on:
  workflow_dispatch:

jobs:
  macos_vnc:
    runs-on: macos-latest
    timeout-minutes: 360

    steps:
    - name: Check System
      run: sw_vers

    - name: Setup Tailscale (using OAuth)
      uses: tailscale/github-action@v3
      with:
        oauth-client-id: ${{ secrets.TS_OAUTH_ID }}
        oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
        tags: tag:ci # Ø§ÛŒÙ† ØªÚ¯ Ø§Ø®ØªÛŒØ§Ø±ÛŒ Ø§Ø³Øª Ø§Ù…Ø§ Ø¨Ù‡ Ù…Ø¯ÛŒØ±ÛŒØª Ø¨Ù‡ØªØ± Ú©Ù…Ú© Ù…ÛŒâ€ŒÚ©Ù†Ø¯

    - name: Enable macOS Native VNC
      run: |
        # ØªÙ†Ø¸ÛŒÙ… Ù¾Ø³ÙˆØ±Ø¯ ÛŒÙˆØ²Ø± Ø³ÛŒØ³ØªÙ…
        sudo dscl . -passwd /Users/runner password
        
        # ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Screen Sharing Ø§ØµÙ„ÛŒ Ù…Ú©
        sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -activate -configure -allowAccessFor -allUsers -privs -all \
          -clientopts -setvncpassword -vncpasswd password \
          -restart -agent -quiet
        
        echo "âœ… VNC setup complete."

    - name: Print Connection Info
      run: |
        IP=$(tailscale ip -4)
        echo "------------------------------------------"
        echo "ğŸš€ CONNECTION DETAILS:"
        echo "Address: $IP:5900"
        echo "User: runner"
        echo "Pass: password"
        echo "------------------------------------------"

    - name: Keep Alive
      run: |
        echo "â³ Running... Connect now!"
        sleep 21600
        
