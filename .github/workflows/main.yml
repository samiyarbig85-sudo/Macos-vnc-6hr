name: macOS GUI via VNC (6 Hour Session) - Tailscale

on:
  workflow_dispatch:

jobs:
  macos_vnc:
    runs-on: macos-latest
    timeout-minutes: 360  # 6 Ø³Ø§Ø¹Øª

    steps:
    - name: Show system info
      run: |
        sw_vers
        uname -a
        whoami

    - name: Setup Tailscale
      uses: tailscale/github-action@v3
      with:
        authkey: ${{ secrets.TAILSCALE_AUTHKEY }}

    - name: Enable macOS Native VNC (Screen Sharing)
      run: |
        # ØªÙ†Ø¸ÛŒÙ… Ù¾Ø³ÙˆØ±Ø¯ Ø¨Ø±Ø§ÛŒ ÛŒÙˆØ²Ø±ÛŒ Ú©Ù‡ Ø¨Ø§ Ø¢Ù† Ù„Ø§Ú¯ÛŒÙ† Ù‡Ø³ØªÛŒÙ… (runner)
        sudo dscl . -passwd /Users/runner password
        
        # ÙØ¹Ø§Ù„ Ø³Ø§Ø²ÛŒ Screen Sharing (VNC Ø§ØµÙ„ÛŒ Ø§Ù¾Ù„)
        sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -activate -configure -allowAccessFor -allUsers -privs -all \
          -clientopts -setvncpassword -vncpasswd password \
          -restart -agent -quiet
        
        echo "âœ… Native VNC is enabled with password: password"

    - name: Print Connection Info
      run: |
        # Ø¯Ø±ÛŒØ§ÙØª Ø¢ÛŒâ€ŒÙ¾ÛŒ Ø§Ø² Tailscale
        IP=$(tailscale ip -4)
        echo "------------------------------------------"
        echo "ğŸ”— VNC Connection Details:"
        echo "Address: $IP:5900"
        echo "Username: runner"
        echo "Password: password"
        echo "------------------------------------------"
        echo "Ù†Ú©ØªÙ‡: Ø§Ø² Ù¾ÙˆØ±Øª 5900 Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯ (Ù¾ÙˆØ±Øª Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ù…Ú©)"

    - name: Keep session alive for 6 hours
      run: |
        echo "â³ Session started. macOS is live for 6 hours."
        # Ø­Ù„Ù‚Ù‡ Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø² Ù†Ú¯Ù‡ Ø¯Ø§Ø´ØªÙ† Ø³Ø´Ù†
        sleep 21600
        
